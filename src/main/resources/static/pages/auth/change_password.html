<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đổi Mật Khẩu - Hotel Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/toast.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <h3><i class="fas fa-hotel"></i> Loading...</h3>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1 style="margin: 0;">Đổi mật khẩu</h1>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">Cập nhật mật khẩu của bạn</p>
            </div>
            <div>
                <span id="user-fullname">...</span>
            </div>
        </div>

        <!-- Change Password Form -->
        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <form id="changePassForm">
                <div class="form-group">
                    <label>Mật khẩu cũ *</label>
                    <input type="password" id="oldPass" required placeholder="Nhập mật khẩu hiện tại">
                </div>
                <div class="form-group">
                    <label>Mật khẩu mới *</label>
                    <input type="password" id="newPass" required placeholder="Nhập mật khẩu mới">
                </div>
                <div class="form-group">
                    <label>Nhập lại mật khẩu mới *</label>
                    <input type="password" id="confirmPass" required placeholder="Xác nhận mật khẩu mới">
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Cập Nhật Mật Khẩu
                </button>
            </form>
        </div>
    </div>

    <script src="../../js/common/toast.js"></script>
    <script src="../../js/common/config.js"></script>
    <script src="../../js/common/auth.js"></script>
    <script>
        let currentUser = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Check authentication
            currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = '/pages/auth/login.html';
                return;
            }

            // Display user info
            document.getElementById('user-fullname').textContent = currentUser.fullName;

            // Render sidebar based on role
            renderSidebar(currentUser.role);
        });

        /**
         * Render sidebar based on user role
         */
        function renderSidebar(role) {
            const sidebar = document.getElementById('sidebar');

            if (role === 'ADMIN') {
                sidebar.innerHTML = `
                    <h3>Administrator</h3>
                    <a href="../admin/dashboard.html">Dashboard</a>
                    <a href="../admin/users.html">Quản lý người dùng</a>
                    <a href="../regional_manager/regional_report.html">Báo cáo</a>
                    <a href="change_password.html" class="active">Đổi mật khẩu</a>
                    <a href="#" onclick="handleLogout(); return false;">Đăng xuất</a>
                `;
            } else if (role === 'BRANCH_MANAGER') {
                sidebar.innerHTML = `
                    <h3>Quản lý chi nhánh</h3>
                    <a href="../branch_manager/dashboard.html">Tổng quan</a>
                    <a href="../common/room_management.html">Quản lý phòng</a>
                    <a href="../branch_manager/branch_report.html">Báo cáo</a>
                    <a href="change_password.html" class="active">Đổi mật khẩu</a>
                    <a href="#" onclick="handleLogout(); return false;">Đăng xuất</a>
                `;
            } else if (role === 'REGIONAL_MANAGER') {
                sidebar.innerHTML = `
                    <h3>Lãnh đạo khu vực</h3>
                    <a href="../regional_manager/dashboard.html">Tổng quan</a>
                    <a href="../regional_manager/regional_report.html">Báo cáo</a>
                    <a href="change_password.html" class="active">Đổi mật khẩu</a>
                    <a href="#" onclick="handleLogout(); return false;">Đăng xuất</a>
                `;
            } else if (role === 'RECEPTIONIST') {
                sidebar.innerHTML = `
                    <h3>Lễ tân</h3>
                    <a href="../receptionist/room_grid.html">Quản lý phòng</a>
                    <a href="../receptionist/stay_management.html">Quản lý lưu trú</a>
                    <a href="../receptionist/service_requests.html">Yêu cầu dịch vụ</a>
                    <a href="../receptionist/stay_history.html">Lịch sử lưu trú</a>
                    <a href="change_password.html" class="active">Đổi mật khẩu</a>
                    <a href="#" onclick="handleLogout(); return false;">Đăng xuất</a>
                `;
            } else if (role === 'HOUSEKEEPER') {
                sidebar.innerHTML = `
                    <h3>Buồng phòng</h3>
                    <a href="../housekeeper/room_management.html">Trạng thái phòng</a>
                    <a href="change_password.html" class="active">Đổi mật khẩu</a>
                    <a href="#" onclick="handleLogout(); return false;">Đăng xuất</a>
                `;
            } else {
                sidebar.innerHTML = `
                    <h3>Người dùng</h3>
                    <a href="change_password.html" class="active">Đổi mật khẩu</a>
                    <a href="#" onclick="handleLogout(); return false;">Đăng xuất</a>
                `;
            }
        }

        /**
         * Handle password change form submission
         */
        document.getElementById('changePassForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const oldPass = document.getElementById('oldPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;

            // Validation
            if (newPass !== confirmPass) {
                showError('Mật khẩu mới không khớp!');
                return;
            }

            if (newPass.length < 6) {
                showError('Mật khẩu mới phải có ít nhất 6 ký tự!');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldPassword: oldPass,
                        newPassword: newPass
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Không thể đổi mật khẩu');
                }

                const result = await response.json();
                showSuccess(result.message || 'Đổi mật khẩu thành công!');

                // Clear form
                document.getElementById('changePassForm').reset();

                // Redirect to login after 2 seconds
                setTimeout(() => {
                    handleLogout();
                }, 2000);

            } catch (error) {
                console.error('Error changing password:', error);
                showError(error.message || 'Đã xảy ra lỗi khi đổi mật khẩu');
            }
        });
    </script>
</body>

</html>