<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªïi M·∫≠t Kh·∫©u - Hotel Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/toast.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <h3><i class="fas fa-hotel"></i> Loading...</h3>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1 style="margin: 0;">üîë ƒê·ªïi M·∫≠t Kh·∫©u</h1>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u c·ªßa b·∫°n</p>
            </div>
            <div>
                <span id="user-fullname">...</span>
            </div>
        </div>

        <!-- Change Password Form -->
        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <form id="changePassForm">
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u c≈© *</label>
                    <input type="password" id="oldPass" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i">
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u m·ªõi *</label>
                    <input type="password" id="newPass" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
                </div>
                <div class="form-group">
                    <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi *</label>
                    <input type="password" id="confirmPass" required placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi">
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> C·∫≠p Nh·∫≠t M·∫≠t Kh·∫©u
                </button>
            </form>
        </div>
    </div>

    <script src="../../js/common/toast.js"></script>
    <script src="../../js/common/config.js"></script>
    <script src="../../js/common/auth.js"></script>
    <script>
        let currentUser = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Check authentication
            currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = '/pages/auth/login.html';
                return;
            }

            // Display user info
            document.getElementById('user-fullname').textContent = currentUser.fullName;

            // Render sidebar based on role
            renderSidebar(currentUser.role);
        });

        /**
         * Render sidebar based on user role
         */
        function renderSidebar(role) {
            const sidebar = document.getElementById('sidebar');

            if (role === 'ADMIN') {
                sidebar.innerHTML = `
                    <h3><i class="fas fa-user-shield"></i> Admin</h3>
                    <a href="../admin/dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a href="../admin/users.html"><i class="fas fa-users"></i> Qu·∫£n l√Ω Users</a>
                    <a href="../regional_manager/regional_report.html"><i class="fas fa-file-alt"></i> B√°o C√°o</a>
                    <a href="change_password.html" class="active"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a>
                    <a href="#" onclick="handleLogout(); return false;"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                `;
            } else if (role === 'BRANCH_MANAGER') {
                sidebar.innerHTML = `
                    <h3><i class="fas fa-user-tie"></i> Qu·∫£n L√Ω</h3>
                    <a href="../branch_manager/dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
                    <a href="../common/room_management.html"><i class="fas fa-door-open"></i> Qu·∫£n L√Ω Ph√≤ng</a>
                    <a href="../branch_manager/branch_report.html"><i class="fas fa-file-alt"></i> B√°o c√°o</a>
                    <a href="change_password.html" class="active"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a>
                    <a href="#" onclick="handleLogout(); return false;"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                `;
            } else if (role === 'REGIONAL_MANAGER') {
                sidebar.innerHTML = `
                    <h3><i class="fas fa-globe"></i> Qu·∫£n L√Ω Khu V·ª±c</h3>
                    <a href="../regional_manager/dashboard.html"><i class="fas fa-chart-line"></i> T·ªïng Quan</a>
                    <a href="../regional_manager/regional_report.html"><i class="fas fa-chart-bar"></i> B√°o C√°o</a>
                    <a href="change_password.html" class="active"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a>
                    <a href="#" onclick="handleLogout(); return false;"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                `;
            } else if (role === 'RECEPTIONIST') {
                sidebar.innerHTML = `
                    <h3><i class="fas fa-hotel"></i> L·ªÖ T√¢n</h3>
                    <a href="../receptionist/dashboard.html"><i class="fas fa-clipboard-list"></i> Qu·∫£n L√Ω ƒê·∫∑t Ph√≤ng</a>
                    <a href="../receptionist/room_management.html"><i class="fas fa-door-open"></i> Qu·∫£n L√Ω Ph√≤ng</a>
                    <a href="change_password.html" class="active"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a>
                    <a href="#" onclick="handleLogout(); return false;"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                `;
            } else if (role === 'HOUSEKEEPER') {
                sidebar.innerHTML = `
                    <h3><i class="fas fa-broom"></i> Nh√¢n Vi√™n</h3>
                    <a href="../housekeeper/room_management.html"><i class="fas fa-door-open"></i> Qu·∫£n L√Ω Ph√≤ng</a>
                    <a href="change_password.html" class="active"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a>
                    <a href="#" onclick="handleLogout(); return false;"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                `;
            } else {
                sidebar.innerHTML = `
                    <h3><i class="fas fa-user"></i> User</h3>
                    <a href="change_password.html" class="active"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a>
                    <a href="#" onclick="handleLogout(); return false;"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                `;
            }
        }

        /**
         * Handle password change form submission
         */
        document.getElementById('changePassForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const oldPass = document.getElementById('oldPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;

            // Validation
            if (newPass !== confirmPass) {
                showError('M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!');
                return;
            }

            if (newPass.length < 6) {
                showError('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldPassword: oldPass,
                        newPassword: newPass
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u');
                }

                const result = await response.json();
                showSuccess(result.message || 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');

                // Clear form
                document.getElementById('changePassForm').reset();

                // Redirect to login after 2 seconds
                setTimeout(() => {
                    handleLogout();
                }, 2000);

            } catch (error) {
                console.error('Error changing password:', error);
                showError(error.message || 'ƒê√£ x·∫£y ra l·ªói khi ƒë·ªïi m·∫≠t kh·∫©u');
            }
        });
    </script>
</body>

</html>