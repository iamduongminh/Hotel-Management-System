<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Xuất Báo Cáo - Khu Vực</title>
    <link rel="stylesheet" href="../../css/style.css">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Will be populated by JS -->
        <h3>Loading...</h3>
    </div>

    <div class="main-content">
        <h1><i class="fas fa-chart-bar"></i> Báo Cáo Tổng Hợp (Khu Vực)</h1>
        <div class="card" style="max-width: 600px;">
            <div class="form-group">
                <label>Loại báo cáo:</label>
                <select id="reportType">
                    <option value="REVENUE">Báo cáo Doanh thu (Revenue)</option>
                    <option value="OCCUPANCY">Tỷ lệ lấp đầy (Occupancy)</option>
                </select>
            </div>
            <button onclick="exportReport()" class="btn-primary"><i class="fas fa-download"></i> Xuất Báo Cáo</button>
        </div>
        <div id="reportResult" style="margin-top: 20px; padding: 10px; background: white;"></div>
    </div>

    <script src="../../js/common/config.js"></script>
    <script src="../../js/common/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const user = getCurrentUser();
            if (!user) {
                window.location.href = '/pages/auth/login.html';
                return;
            }
            renderSidebar(user.role);
        });

        function renderSidebar(role) {
            const sidebar = document.getElementById('sidebar');

            if (role === 'REGIONAL_MANAGER') {
                sidebar.innerHTML = `
                    <h3><i class="fas fa-globe"></i> Lãnh Đạo Khu Vực</h3>
                    <a href="dashboard.html"><i class="fas fa-chart-line"></i> Tổng Quan</a>
                    <a href="branch_management.html"><i class="fas fa-building"></i> Quản Lý Chi Nhánh</a>
                    <a href="regional_report.html" class="active"><i class="fas fa-chart-bar"></i> Báo Cáo Tổng Hợp</a>
                    <a href="#" onclick="handleLogout(); return false;"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
                `;
            } else {
                sidebar.innerHTML = `
                    <h3><i class="fas fa-ban"></i> Truy cập bị từ chối</h3>
                    <p>Trang này chỉ dành cho Lãnh Đạo Khu Vực</p>
                    <a href="../auth/login.html" style="color: white; text-decoration: underline;">Quay lại đăng nhập</a>
                `;
            }
        }

        async function exportReport() {
            const type = document.getElementById('reportType').value;
            const req = {
                type: type,
                start: new Date().toISOString(),
                end: new Date().toISOString()
            };

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/reports/export`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(req)
                });

                if (!response.ok) {
                    throw new Error('Failed to export report');
                }

                const result = await response.text();
                document.getElementById('reportResult').innerText = result;
                document.getElementById('reportResult').style.color = 'black';
            } catch (e) {
                alert("Lỗi: " + e.message);
            }
        }
    </script>
</body>

</html>